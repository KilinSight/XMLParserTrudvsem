{% extends 'base.html.twig' %}


{% block stylesheets %}
    {{ parent() }}
    <style>
        /* Remove the navbar's default margin-bottom and rounded borders */
        .navbar {
            margin-bottom: 0;
            border-radius: 0;
        }

        /* Add a gray background color and some padding to the footer */
        footer {
            background-color: #f2f2f2;
            padding: 25px;
        }

        /* Hide the carousel text when the screen is less than 600 pixels wide */
        @media (max-width: 600px) {
            .carousel-caption {
                display: none;
            }
        }
        input {
            width: 50%;
            z-index: -10;
            margin: 8px 0 8px 0;
        }

        .c-regions {
            position: relative;
        }

        .c-regions__container {
            position: absolute;
            background-color: #eeeeee;
            width: 100%;
            list-style: none;
            padding: 0;
            border: 1px solid #999999;
            border-bottom: none;
            top: 35px;
            left: 0;
            display: none;
            max-height: 350px;
            overflow: auto;
            z-index: 10;
            font-size: 14px;
            line-height: 1.42857143;
            color: #666666;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
            box-shadow: inset 0 1px 1px rgba(0,0,0,.075);

        }

        .c-regions__container--active {
            display: block;
        }

        .c-regions__container li{
            height: 26px;
            line-height: 26px;
            border-bottom: 1px solid #dddddd;
        }

        .c-regions__container li:hover{
            background-color: #dddddd;
        }
        h5 {
            margin-top: 25px;
            margin-bottom: 25px;
            font-size: 18px;
        }

        .get-regions {
            margin: 50px;
        }

        .both-col {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .left-col {
            width: 35%;
        }

        .right-col {
            width: 55%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #eeeeee;
            border-radius: 4px;
            box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
        }

        .right-col h2 {
            margin: 0 auto;
        }

        @media screen and (max-width: 1200px) {
            .both-col {
                justify-content: center;
            }

            .left-col {
                width: 95%;
            }
            .right-col {
                margin-top: 75px;
                margin-bottom: 50px;
                min-height: 300px;
                width: 95%;
            }
        }
    </style>
{% endblock %}

{% block body %}
    <body>

    <div class="container text-center">
        <div class="row">
            <div class="col-md-12">
                <div class="panel-body">
                    <h1><span>Обработка открытых данных с сайта trudvsem.ru</h1>
                </div>
            </div>
        </div>
            <div class="row both-col">
            <div class="left-col">
                <form action="/get_results" method="POST" class="search-form">
                    <h5>Введите параметры поиска:</h5>
                    <div class="c-regions">
                        <input  autocomplete="off" class="c-regions__input form-control" type="text" id="searchQuery" name="searchQuery" placeholder="Введите запрос">
                        <ul class="c-regions__container">
                        </ul>
                    </div>
                    <input class="form-control" type="text" id="vacancy" name="vacancy" placeholder="Введите вакансию">
                    <input class="form-control" type="text" id="region" name="region" placeholder="Введите регион">
                    <input class="form-control" type="text" id="town" name="town" placeholder="Введите город">
                    <h5>Введите диапазон заработной платы:</h5><input class="form-control" type="text" name="money1" id="money1" placeholder="От">
                    <input  class="form-control" type="text" id="money2" name="money2" placeholder="До">
                    <button class="btn btn-default" type="submit" name="search" value="1">Будем поискать</button>
                </form>
            </div>
                <div class="right-col">
                    <h2>Выберите параметры в меню</h2>
                </div>
            </div>
            <div class="container col-sm-12">
                <div class="row get-regions">

                    <form action="/get_results" method="POST" class="search-form">
                        <button class="btn btn-success btn-lg" type="submit">Получить регионы</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    </body>
    </html>

{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
        var progress = {'done':false, 'offset':0};
        var count = 1;
        var timeout;
        var sendAjaxVacancies = function (progress) {
            $.ajax({
                url: Routing.generate('api_vacancies'),
                data: {
                    limit: 10000000,
                    offset: progress.offset
                },
                success: function (arr) {
                    data = JSON.parse(arr);
                    if (!progress.done){
                        progress.offset = data.offset;
                        progress.done = data.done;
                        timeout = setTimeout(sendAjaxVacancies,60000,progress);
                    }else{
                        progress.offset = data.offset;
                        progress.done = data.done;
                        clearTimeout(timeout);
                    }
                }
            });
        };
        $(document).ready(function (){
            var arrRegions =[];
            $.ajax({
                url: Routing.generate('api_regions'),
                success:function(data) {
                    var regions = JSON.parse(data);
                    console.log(regions.region[0].name);
                    regions.region.map(function(item,key){
                        // console.log(item);
                        arrRegions.push({"name": item.name, "code": item.code });
                    });

                    sortRegions();
                }
            });

            sendAjaxVacancies(progress);

            // $.ajax({
            //     url: Routing.generate('api_vacancies'),
            //     success:function(data) {
            //         var regions.region = JSON.parse(data);
            //         console.log(regions);
            //         // regions.region.map(function(item,key){
            //         //     console.log(item.name);
            //         // });
            //     }
            // });


            var arrSort = arrRegions.slice();


            function sortRegions() {
                arrRegions.sort(function (a, b) {
                    return a.name.localeCompare(b.name);
                });
                showData(arrRegions);
            }

            $('.c-regions__input').focus(function () {
                $('.c-regions__container').addClass('c-regions__container--active');
            });


            $('.c-regions__input').blur(function () {
                setTimeout(function() {
                    $('.c-regions__container').removeClass('c-regions__container--active');
                }, 200)
            })

            $('.c-regions__input').keyup(function () {
                var inputValue = $('.c-regions__input').val().toUpperCase(),
                    container = $('.c-regions__container');
                if (inputValue == false) {
                    arrSort = arrRegions.slice();
                    showData(arrRegions);
                }
                else {
                    container.empty();
                    arrSort = [];
                    arrRegions.forEach(function(elem) {

                        if ((elem.name.toUpperCase().indexOf(inputValue) >= 0) || ((''+elem.code).toUpperCase().indexOf(inputValue)) >= 0) {
                            arrSort[arrSort.length] = {
                                name: elem.name,
                                code: elem.code
                            };
                        }
                    })
                    showData(arrSort);
                }
            });


            function showData (arr) {
                var container = $('.c-regions__container'),
                    html = [];

                container.empty();

                arr.forEach(function(value) {
                    html.push('<li data-id="'+ value.code +'">' + value.name + '</li>');
                });
                container.append(html);

                $('.c-regions__container li').click(function () {
                    var regionId = $(this).data('id'),
                        regionName = $(this).html();
                    $('.c-regions__input').attr('data-id',regionId);
                    $('.c-regions__input').val(regionName);

                })
            }
        });

    </script>
{% endblock %}

